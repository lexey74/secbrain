# SecBrain - Разделённая архитектура

## 📋 Обзор

SecBrain теперь разделён на **два независимых скрипта** для большей гибкости:

### 1️⃣ `download.py` - Загрузка и подготовка данных
- ✅ Скачивание через gallery-dl (медиа, описание)
- ✅ Транскрибация видео через Whisper
- ✅ Опционально: Комментарии через Playwright (безопасно)
- ✅ Сохранение сырых данных (caption.md, transcript.md, comments.md)
- ❌ **НЕ создаёт Note.md**
- ⚡ Быстрая работа (без AI)

### 2️⃣ `process.py` - AI обработка
- ✅ Обходит все папки в SecondBrain_Inbox
- ✅ Находит необработанные (без Note.md)
- ✅ AI анализ через qwen2.5:7b
- ✅ Генерация тегов через TagManager
- ✅ Создание финального Note.md
- ⚡ Пропускает уже обработанные папки

---

## 🚀 Использование

### Вариант 1: Разделённый workflow (рекомендуется)

```bash
# Шаг 1: Скачать несколько постов БЕЗ AI обработки
python src/download.py
# Вводите URL один за другим, программа скачает все данные

# Шаг 2: Запустить AI обработку всех необработанных
python src/process.py
# Автоматически обработает все папки без Note.md
```

**Преимущества:**
- Можно скачать 10-20 постов быстро (без ожидания AI)
- Затем запустить AI обработку одной командой
- Идемпотентность: повторный запуск `process.py` пропустит готовые

### Вариант 2: Полный цикл в одной сессии

```bash
python src/main.py
# Старый способ: скачивание + AI за один проход
```

---

## 📁 Структура данных

### После `download.py`:
```
SecondBrain_Inbox/
  └── 2026-01-07_author_title/
      ├── media.mp4          # Видео
      ├── media_2.jpg        # Изображение 2
      ├── media_3.jpg        # Изображение 3
      ├── caption.md         # Описание поста
      ├── transcript.md      # Транскрипция (с таймкодами + чистый текст)
      └── comments.md        # Все комментарии
```

### После `process.py`:
```
SecondBrain_Inbox/
  └── 2026-01-07_author_title/
      ├── media.mp4
      ├── media_2.jpg
      ├── media_3.jpg
      ├── caption.md
      ├── transcript.md
      ├── comments.md
      └── Note.md            # ✨ ФИНАЛЬНАЯ ЗАМЕТКА для Obsidian
```

---

## 🎯 Примеры использования

### Пример 1: Быстрая загрузка коллекции
```bash
# Утром: скачиваю 20 интересных постов
python src/download.py
# Ввожу URL, URL, URL... (без ожидания AI)

# Вечером: запускаю AI обработку
python src/process.py
# Иду пить кофе, пока AI обрабатывает всё
```

### Пример 2: Повторная обработка
```bash
# Если AI упал на 5-м посте из 10:
python src/process.py
# Автоматически продолжит с 5-го (пропустит 1-4)
```

### Пример 3: Изменение промпта
```bash
# 1. Обновляю SYSTEM_PROMPT в local_brain.py
# 2. Удаляю Note.md из нужных папок:
rm SecondBrain_Inbox/*/Note.md
# 3. Перезапускаю AI:
python src/process.py
# Все посты обработаются с новым промптом
```

---

## ⚙️ Конфигурация

### config.json
```json
{
  "output_dir": "SecondBrain_Inbox",
  "temp_dir": "temp",
  "whisper_model": "base",
  "ollama_model": "qwen2.5:7b",
  "num_threads": 8,
  "num_ctx": 8192,
  "max_comments": 50,
  "max_tags": 15
}
```

### Параметры производительности:
- `num_threads`: Количество потоков для Whisper и Ollama (4-8 для VPS)
- `num_ctx`: Размер контекста LLM (8192 для qwen2.5:7b)
- `whisper_model`: `tiny`, `base`, `small`, `medium`, `large`

---

## 🧠 AI обработка

### Что делает LocalBrain:
1. Анализирует caption + transcript + comments
2. Генерирует резюме на русском (3-5 bullet points)
3. Создаёт теги (приоритет на KNOWN TAGS)
4. Категоризирует (Tutorial, Opinion, News, Life, Humor)
5. Фильтрует ценные комментарии

### Что делает TagManager:
1. Хранит базу известных тегов (`known_tags.json`)
2. Добавляет новые уникальные теги
3. Предотвращает дубликаты (coding vs programming)

---

## 🔄 Workflow

```
┌─────────────┐
│ Instagram   │
│    URL      │
└──────┬──────┘
       │
       ▼
┌─────────────────────────────────┐
│  download.py                    │
│  • gallery-dl скачивание        │
│  • Whisper транскрибация        │
│  • Сохранение сырых данных      │
└──────┬──────────────────────────┘
       │
       ▼
┌─────────────────────────────────┐
│ Папка БЕЗ Note.md               │
│ (необработанная)                │
└──────┬──────────────────────────┘
       │
       ▼
┌─────────────────────────────────┐
│  process.py                     │
│  • LocalBrain анализ            │
│  • TagManager теги              │
│  • Создание Note.md             │
└──────┬──────────────────────────┘
       │
       ▼
┌─────────────────────────────────┐
│ Папка С Note.md                 │
│ (готова для Obsidian)           │
└─────────────────────────────────┘
```

---

## 💡 Советы

### Оптимизация скорости:
1. Скачивайте много постов через `download.py`
2. Запускайте `process.py` на ночь
3. Используйте `qwen2.5:7b` (быстрее mistral-nemo)

### Работа с ошибками:
1. Если AI упал - просто перезапустите `process.py`
2. Если транскрипция не нужна - удалите из `download.py`
3. Если нужны другие теги - измените `SYSTEM_PROMPT`

### Backup:
```bash
# Сохраняйте сырые данные перед экспериментами с AI
cp -r SecondBrain_Inbox SecondBrain_Inbox_backup
```

---

## 📊 Производительность

**VPS Contabo (8 cores, 24GB RAM):**
- `download.py`: ~5-10 сек на пост (галерея 13 фото)
- `download.py`: ~30-60 сек на видео (Whisper транскрипция)
- `process.py`: ~15-30 сек на пост (AI анализ qwen2.5:7b)

**Итого:** 
- 10 постов скачать: 5-10 минут
- 10 постов обработать AI: 3-5 минут

---

## 🛠️ Troubleshooting

### `download.py` не скачивает:
```bash
# Проверьте cookies
ls -lah instagram_cookies.txt

# Проверьте gallery-dl
gallery-dl --version
```

### `process.py` пропускает все папки:
```bash
# Проверьте наличие Note.md
find SecondBrain_Inbox -name "Note.md"

# Удалите Note.md для повторной обработки
rm SecondBrain_Inbox/*/Note.md
```

### AI возвращает пустой ответ:
```bash
# Проверьте Ollama
ollama list
ollama run qwen2.5:7b "test"

# Проверьте логи process.py
```

---

## 📝 Changelog

### v2.0 (Разделённая архитектура)
- ✨ Новый `download.py` - быстрая загрузка без AI
- ✨ Новый `process.py` - пакетная AI обработка
- ✅ Идемпотентность: пропуск готовых папок
- ✅ Сохранение сырых данных в отдельных файлах
- ⚡ Оптимизация workflow

### v1.0 (Монолитная)
- ✅ Единый `main.py` для всех операций
- ✅ Последовательная обработка

---

## 🎓 Дальнейшее развитие

- [ ] Добавить `--batch` режим в download.py (читать URLs из файла)
- [ ] Добавить `--reprocess` флаг в process.py (игнорировать Note.md)
- [ ] Добавить прогресс-бар для пакетной обработки
- [ ] Добавить экспорт статистики (сколько постов, тегов, авторов)
- [ ] Добавить фильтрацию по авторам/датам

---

**Создано:** 2026-01-10  
**Версия:** 2.0  
**Лицензия:** MIT
