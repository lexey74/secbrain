#!/bin/bash
# Скрипт мониторинга транскрибации

PID=104030
LOG_FILE="transcribe.log"

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "🔍 МОНИТОРИНГ ТРАНСКРИБАЦИИ"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "PID: $PID"
echo "Лог: $LOG_FILE"
echo "Время запуска: $(date '+%Y-%m-%d %H:%M:%S')"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

# Проверяем процесс каждые 30 секунд
while true; do
    clear
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "🔍 СТАТУС ТРАНСКРИБАЦИИ"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "⏰ Время проверки: $(date '+%Y-%m-%d %H:%M:%S')"
    echo ""
    
    # Проверяем, жив ли процесс
    if ps -p $PID > /dev/null 2>&1; then
        echo "✅ Процесс работает (PID: $PID)"
        
        # Показываем информацию о процессе
        echo ""
        echo "📊 Информация о процессе:"
        ps -p $PID -o pid,ppid,%cpu,%mem,etime,cmd --no-headers | \
            awk '{printf "   PID: %s\n   CPU: %s%%\n   Memory: %s%%\n   Время работы: %s\n", $1, $3, $4, $5}'
        
    else
        echo "❌ Процесс завершён"
        echo ""
        echo "📊 ФИНАЛЬНАЯ СТАТИСТИКА"
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        
        # Показываем последние 50 строк лога
        if [ -f "$LOG_FILE" ]; then
            echo ""
            echo "📄 Последние записи из лога:"
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            tail -50 "$LOG_FILE"
        fi
        
        echo ""
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        echo "🏁 Мониторинг завершён"
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        break
    fi
    
    echo ""
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "📝 ПОСЛЕДНИЕ ЗАПИСИ ЛОГА (30 строк):"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    
    if [ -f "$LOG_FILE" ]; then
        tail -30 "$LOG_FILE"
    else
        echo "⚠️  Лог-файл не найден"
    fi
    
    echo ""
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "⏳ Следующая проверка через 30 секунд..."
    echo "   (Нажмите Ctrl+C для выхода)"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    
    sleep 30
done
